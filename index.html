<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista da Vez</title>
    <meta name="description" content="Sistema de controle de fila de atendimento com registro de vendas para vendedores">
    <!-- Font Awesome para Ã­cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, hsl(240, 10%, 98%), hsl(240, 10%, 96%));
            min-height: 100vh;
            color: hsl(222.2, 84%, 4.9%);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: hsl(222.2, 84%, 4.9%);
            margin-bottom: 8px;
        }
        .header p {
            font-size: 1.125rem;
            color: hsl(215.4, 16.3%, 46.9%);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px -4px hsl(210, 85%, 40%, 0.1);
            border: 1px solid hsl(214.3, 31.8%, 91.4%);
        }
        .card-header {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stat-card {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .stat-icon {
            width: 20px;
            height: 20px;
            color: hsl(210, 85%, 40%);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.875rem;
            color: hsl(215.4, 16.3%, 46.9%);
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        .current-service {
            background: linear-gradient(135deg, hsl(210, 85%, 40%), hsl(210, 85%, 60%));
            color: white;
            text-align: center;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .current-service h3 {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }
        .current-service p {
            opacity: 0.8;
            margin-bottom: 8px;
        }
        .service-time {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            opacity: 0.6;
            font-size: 0.875rem;
        }
        .button-group {
            display: flex;
            gap: 12px;
        }
        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn-success {
            background: linear-gradient(135deg, hsl(142, 76%, 36%), hsl(142, 76%, 56%));
            color: white;
        }
        .btn-success:hover {
            box-shadow: 0 10px 30px -10px hsl(142, 76%, 36%, 0.2);
        }
        .btn-danger {
            background: linear-gradient(135deg, hsl(0, 84.2%, 60.2%), hsl(0, 84.2%, 70.2%));
            color: white;
        }
        .btn-primary {
            background: linear-gradient(135deg, hsl(210, 85%, 40%), hsl(210, 85%, 60%));
            color: white;
            width: 100%;
        }
        .btn-outline {
            background: white;
            color: hsl(222.2, 84%, 4.9%);
            border: 1px solid hsl(214.3, 31.8%, 91.4%);
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 0.875rem;
            border-radius: 6px;
        }
        .btn-delete {
            background: linear-gradient(135deg, hsl(0, 72%, 51%), hsl(0, 72%, 71%));
            color: white;
        }
        .employee-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .add-employee-form {
            background: hsl(210, 40%, 96.1%);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid hsl(214.3, 31.8%, 91.4%);
            border-radius: 6px;
            font-size: 0.875rem;
        }
        .form-input:focus {
            outline: none;
            border-color: hsl(210, 85%, 40%);
            box-shadow: 0 0 0 2px hsl(210, 85%, 40%, 0.2);
        }
        .form-actions {
            display: flex;
            gap: 8px;
        }
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: hsl(215.4, 16.3%, 46.9%);
        }
        .empty-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            opacity: 0.5;
        }
        .queue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: hsl(210, 40%, 96.1%);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .queue-position {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            border: 1px solid hsl(214.3, 31.8%, 91.4%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .employee-info h4 {
            font-weight: 500;
            margin-bottom: 2px;
        }
        .employee-info p {
            font-size: 0.875rem;
            color: hsl(215.4, 16.3%, 46.9%);
        }
        .badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-success {
            background: hsl(142, 76%, 36%);
            color: white;
        }
        .badge-danger {
            background: hsl(0, 84.2%, 60.2%);
            color: white;
        }
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: hsl(210, 40%, 96.1%);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast-success {
            border-left: 4px solid hsl(142, 76%, 36%);
        }
        .toast-danger {
            border-left: 4px solid hsl(0, 84.2%, 60.2%);
        }
        .success-text { color: hsl(142, 76%, 36%); }
        .stat-success .stat-value { color: hsl(142, 76%, 36%); }
        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: hsl(222.2, 84%, 4.9%);
        }
        [data-theme="dark"] {
            background: linear-gradient(180deg, hsl(240, 10%, 20%), hsl(240, 10%, 15%));
            color: hsl(210, 40%, 90%);
        }
        [data-theme="dark"] .card {
            background: hsl(240, 10%, 25%);
            border-color: hsl(240, 10%, 30%);
        }
        [data-theme="dark"] .form-input {
            background: hsl(240, 10%, 30%);
            color: hsl(210, 40%, 90%);
            border-color: hsl(240, 10%, 40%);
        }
        [data-theme="dark"] .queue-item,
        [data-theme="dark"] .history-item,
        [data-theme="dark"] .add-employee-form {
            background: hsl(240, 10%, 30%);
        }
        [data-theme="dark"] .btn-outline {
            background: hsl(240, 10%, 25%);
            color: hsl(210, 40%, 90%);
            border-color: hsl(240, 10%, 40%);
        }
        .totem-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .totem-item {
            background: hsl(210, 40%, 96.1%);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid hsl(214.3, 31.8%, 91.4%);
        }
        .totem-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px -4px hsl(210, 85%, 40%, 0.2);
        }
        .totem-item h4 {
            font-weight: 500;
            margin-bottom: 8px;
        }
        .totem-item p {
            font-size: 0.875rem;
            color: hsl(215.4, 16.3%, 46.9%);
        }
        [data-theme="dark"] .totem-item {
            background: hsl(240, 10%, 30%);
            border-color: hsl(240, 10%, 40%);
        }
        @media (max-width: 768px) {
            body {
                margin: 10px;
            }
            .container {
                padding: 0 10px;
            }
            .form-input,
            select {
                font-size: 14px;
                padding: 10px;
            }
            .btn {
                font-size: 14px;
                padding: 10px 15px;
                width: 100%;
                margin-bottom: 10px;
            }
            .form-input {
                max-width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle" title="Alternar Modo Claro/Escuro">
        <i class="fas fa-moon"></i>
    </button>
    <div class="container">
        <div class="header">
            <h1>Lista da Vez</h1>
            <p>Controle de fila e vendas dos vendedores</p>
        </div>
        <div class="stats-grid">
            <div class="card">
                <div class="stat-card">
                    <span class="stat-icon"><i class="fas fa-users"></i></span>
                    <div>
                        <div class="stat-label">Na Fila</div>
                        <div class="stat-value" id="queueCount">0</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="stat-card">
                    <span class="stat-icon"><i class="fas fa-clipboard-check"></i></span>
                    <div>
                        <div class="stat-label">Atendimentos</div>
                        <div class="stat-value" id="totalServices">0</div>
                    </div>
                </div>
            </div>
            <div class="card stat-success">
                <div class="stat-card">
                    <span class="stat-icon"><i class="fas fa-chart-line"></i></span>
                    <div>
                        <div class="stat-label">Vendas</div>
                        <div class="stat-value" id="completedSales">0</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="stat-card">
                    <span class="stat-icon"><i class="fas fa-bullseye"></i></span>
                    <div>
                        <div class="stat-label">Taxa de Sucesso</div>
                        <div class="stat-value" id="successRate">0%</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="authSection" class="card">
            <div class="card-header"><i class="fas fa-user"></i> Login / Cadastro</div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="email" placeholder="Digite seu email">
            </div>
            <div class="form-group">
                <label class="form-label">Senha</label>
                <input type="password" class="form-input" id="password" placeholder="Digite sua senha">
            </div>
            <div class="form-actions">
                <button class="btn btn-primary btn-small" id="registerBtn"><i class="fas fa-user-plus"></i> Cadastrar</button>
                <button class="btn btn-primary btn-small" id="loginBtn"><i class="fas fa-sign-in-alt"></i> Entrar</button>
            </div>
        </div>
        <div id="salesSection" style="display: none;">
            <div class="main-grid">
                <div class="card">
                    <div class="card-header"><i class="fas fa-clock"></i> Atendimento Atual</div>
                    <div id="currentServiceArea">
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-user"></i></div>
                            <p>Nenhum vendedor em atendimento</p>
                            <button class="btn btn-primary" id="nextBtn">Iniciar PrÃ³ximo Atendimento</button>
                        </div>
                    </div>
                    <div class="card" id="saleForm" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Vendedor</label>
                            <select class="form-input" id="vendorAssigned" disabled>
                                <option value="">Aguardando vendedor...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Resultado do Atendimento</label>
                            <select class="form-input" id="saleResult">
                                <option value="sold">Venda Realizada</option>
                                <option value="not_sold">NÃ£o Vendido</option>
                            </select>
                        </div>
                        <div class="form-group" id="notSoldReasonGroup" style="display: none;">
                            <label class="form-label">Motivo da NÃ£o Venda</label>
                            <input type="text" class="form-input" id="notSoldReason" placeholder="Motivo da NÃ£o Venda">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Detalhes da Venda (opcional)</label>
                            <input type="text" class="form-input" id="saleDetails" placeholder="Detalhes da Venda">
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-success" id="submitSale"><i class="fas fa-save"></i> Registrar Atendimento</button>
                            <button class="btn btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header" style="justify-content: space-between;">
                        <span><i class="fas fa-users"></i> Fila de Vendedores</span>
                        <div>
                            <button class="btn btn-outline btn-small" id="modeToggleBtn">Modo: Fila</button>
                            <button class="btn btn-outline btn-small" id="resetQueueBtn">Reiniciar Fila</button>
                        </div>
                    </div>
                    <div class="add-employee-form" id="addVendorForm" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Nome do Vendedor</label>
                            <input type="text" class="form-input" id="vendorName" placeholder="Digite o nome do vendedor">
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary btn-small" id="addVendorBtn">Adicionar</button>
                            <button class="btn btn-outline btn-small" id="cancelAddVendorBtn">Cancelar</button>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <span></span>
                        <button class="btn btn-outline btn-small" id="showAddVendorFormBtn">+ Adicionar Vendedor</button>
                    </div>
                    <div id="vendorQueue"></div>
                    <div id="vendorCheckInList"></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><i class="fas fa-file-export"></i> Exportar e Enviar RelatÃ³rios</div>
                <div class="form-actions">
                    <button class="btn btn-success" id="exportPdfBtn"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
                    <button class="btn btn-success" id="exportExcelBtn"><i class="fas fa-file-excel"></i> Baixar Excel</button>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">Enviar RelatÃ³rio por WhatsApp</label>
                    <input type="text" class="form-input" id="phoneNumber" placeholder="NÃºmero de Telefone (Ex: 5511987654321)">
                    <small>Para WhatsApp, use o formato completo com cÃ³digo do paÃ­s (ex: 55 para Brasil).</small>
                </div>
                <button class="btn btn-primary" id="sendReportBtn"><i class="fas fa-paper-plane"></i> Enviar RelatÃ³rio</button>
            </div>
            <div class="card">
                <div class="card-header"><i class="fas fa-history"></i> HistÃ³rico de Atendimentos</div>
                <div id="salesList">
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-clipboard-list"></i></div>
                        <p>Nenhum atendimento registrado ainda</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="toast" class="toast">
            <div id="toastContent"></div>
        </div>
    </div>
    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import {
            getDatabase,
            ref,
            push,
            set,
            update,
            onValue,
            remove
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        const firebaseConfig = {
            apiKey: "AIzaSyDJBdK9I-jtg9ujTc9Xsxr-hnPfkId4wIU",
            authDomain: "pdv1-77632.firebaseapp.com",
            databaseURL: "https://pdv1-77632-default-rtdb.firebaseio.com",
            projectId: "pdv1-77632",
            storageBucket: "pdv1-77632.firebasestorage.app",
            messagingSenderId: "246033791117",
            appId: "1:246033791117:web:7b70b511ea8d8c5ba1cac4",
            measurementId: "G-NTG13SG6VM"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getDatabase();
        let currentSalesData = [];
        let vendorQueue = [];
        let allVendors = [];
        let editId = null;
        let currentEmployee = null;
        let currentMode = 'queue';

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const content = document.getElementById('toastContent');
            content.textContent = message;
            toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-danger'}`;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        document.getElementById("registerBtn").onclick = () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            createUserWithEmailAndPassword(auth, email, password)
                .then(() => showToast("UsuÃ¡rio registrado!", "success"))
                .catch(err => showToast(err.message, "danger"));
        };

        document.getElementById("loginBtn").onclick = () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            signInWithEmailAndPassword(auth, email, password)
                .then(() => showToast("Login realizado!", "success"))
                .catch(err => showToast(err.message, "danger"));
        };

        document.getElementById("logoutBtn").onclick = () => {
            signOut(auth);
            showToast("Logout realizado!", "success");
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById("authSection").style.display = "none";
                document.getElementById("salesSection").style.display = "block";
                loadVendors(user.uid);
                loadSales(user.uid);
            } else {
                document.getElementById("authSection").style.display = "block";
                document.getElementById("salesSection").style.display = "none";
            }
        });

        document.getElementById("modeToggleBtn").onclick = () => {
            currentMode = currentMode === 'queue' ? 'free' : 'queue';
            document.getElementById('modeToggleBtn').textContent = `Modo: ${currentMode === 'queue' ? 'Fila' : 'Livre'}`;
            localStorage.setItem('mode', currentMode);
            renderVendorQueue();
            renderCurrentService();
        };

        const savedMode = localStorage.getItem('mode') || 'queue';
        currentMode = savedMode;
        document.getElementById('modeToggleBtn').textContent = `Modo: ${currentMode === 'queue' ? 'Fila' : 'Livre'}`;

        document.getElementById("addVendorBtn").onclick = () => {
            const vendorName = document.getElementById("vendorName").value.trim();
            if (!vendorName) {
                showToast("Por favor, insira o nome do vendedor.", "danger");
                return;
            }
            const user = auth.currentUser;
            if (user) {
                const vendorsRef = ref(db, `vendors/${user.uid}`);
                const newVendorRef = push(vendorsRef);
                const isJosy = vendorName.toLowerCase() === "josy";
                set(newVendorRef, {
                    name: vendorName,
                    order: allVendors.length,
                    checkedIn: false,
                    priority: isJosy
                }).then(() => {
                    document.getElementById("vendorName").value = "";
                    showToast(`${vendorName} adicionado Ã  fila!`, "success");
                    cancelAddVendor();
                    loadVendors(user.uid);
                }).catch(err => showToast("Erro ao adicionar vendedor: " + err.message, "danger"));
            }
        };

        document.getElementById("showAddVendorFormBtn").onclick = () => {
            document.getElementById("addVendorForm").style.display = "block";
            document.getElementById("vendorName").focus();
        };

        document.getElementById("cancelAddVendorBtn").onclick = cancelAddVendor;

        function cancelAddVendor() {
            document.getElementById("addVendorForm").style.display = "none";
            document.getElementById("vendorName").value = "";
        }

        function renderVendorQueue() {
            const vendorList = document.getElementById('vendorQueue');
            vendorList.innerHTML = '';
            if (currentMode === 'queue') {
                if (vendorQueue.length > 0) {
                    vendorQueue.forEach((vendor, index) => {
                        const div = document.createElement('div');
                        div.className = 'queue-item';
                        div.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="queue-position">${index + 1}</div>
                                <div class="employee-info">
                                    <h4>${vendor.name}</h4>
                                    <p>${vendor.priority ? '<span style="color: gold;">(Prioridade)</span>' : ''}</p>
                                </div>
                            </div>
                        `;
                        vendorList.appendChild(div);
                    });
                } else {
                    vendorList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-users"></i></div>
                            <p>Nenhum vendedor com check-in registrado.</p>
                        </div>
                    `;
                }
            } else {
                const checkedInVendors = allVendors.filter(vendor => vendor.checkedIn);
                if (checkedInVendors.length > 0) {
                    vendorList.className = 'totem-grid';
                    checkedInVendors.forEach(vendor => {
                        const div = document.createElement('div');
                        div.className = 'totem-item';
                        div.innerHTML = `
                            <h4>${vendor.name}</h4>
                            <p>${vendor.priority ? '<span style="color: gold;">(Prioridade)</span>' : ''}</p>
                        `;
                        div.onclick = () => selectVendorForSale(vendor);
                        vendorList.appendChild(div);
                    });
                } else {
                    vendorList.className = '';
                    vendorList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-users"></i></div>
                            <p>Nenhum vendedor com check-in registrado.</p>
                        </div>
                    `;
                }
            }
        }

        function selectVendorForSale(vendor) {
            currentEmployee = { ...vendor, startTime: new Date() };
            const vendorSelect = document.getElementById('vendorAssigned');
            vendorSelect.innerHTML = `<option value="${vendor.id}">${vendor.name}</option>`;
            showToast(`${vendor.name} selecionado para atendimento.`, 'success');
            renderCurrentService();
        }

        function loadVendors(uid) {
            const vendorsRef = ref(db, `vendors/${uid}`);
            onValue(vendorsRef, snapshot => {
                const vendorCheckInList = document.getElementById('vendorCheckInList');
                const vendorSelect = document.getElementById('vendorAssigned');
                allVendors = [];
                vendorQueue = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    allVendors = Object.entries(data).map(([id, vendor]) => ({
                        id,
                        ...vendor
                    }));
                    allVendors.sort((a, b) => a.order - b.order);
                    vendorQueue = allVendors
                        .filter(vendor => vendor.checkedIn)
                        .sort((a, b) => {
                            if (currentMode === 'queue') {
                                if (a.priority && !b.priority) return -1;
                                if (!a.priority && b.priority) return 1;
                                return a.order - b.order;
                            }
                            return 0;
                        });
                    vendorCheckInList.innerHTML = allVendors.map(vendor => `
                        <div class="queue-item">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="employee-info">
                                    <h4>${vendor.name}</h4>
                                    <p>${vendor.priority ? '<span style="color: gold;">(Prioridade)</span>' : ''}</p>
                                    <p>${vendor.checkedIn ? '<span class="success-text">Presente</span>' : '<span class="text-danger">Ausente</span>'}</p>
                                </div>
                            </div>
                            <div class="employee-actions">
                                <button class="btn btn-small ${vendor.checkedIn ? 'btn-danger' : 'btn-success'}" onclick="toggleCheckIn('${vendor.id}', ${!vendor.checkedIn})">
                                    <i class="fas fa-check-circle"></i> ${vendor.checkedIn ? 'Desmarcar' : 'Fazer Check-in'}
                                </button>
                                <button class="btn btn-delete btn-small" onclick="removeVendor('${vendor.id}')">
                                    <i class="fas fa-trash"></i> Remover
                                </button>
                            </div>
                        </div>
                    `).join('');
                    renderVendorQueue();
                    if (currentEmployee) {
                        vendorSelect.innerHTML = `<option value="${currentEmployee.id}">${currentEmployee.name}</option>`;
                    } else {
                        vendorSelect.innerHTML = `<option value="">${currentMode === 'queue' ? 'Nenhum vendedor disponÃ­vel' : 'Selecione um vendedor'}</option>`;
                    }
                } else {
                    vendorCheckInList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-users"></i></div>
                            <p>Nenhum vendedor registrado.</p>
                        </div>
                    `;
                    renderVendorQueue();
                    vendorSelect.innerHTML = `<option value="">${currentMode === 'queue' ? 'Nenhum vendedor disponÃ­vel' : 'Selecione um vendedor'}</option>`;
                }
                updateStats();
            });
        }

        window.toggleCheckIn = (id, checkInStatus) => {
            const user = auth.currentUser;
            if (!user) return;
            update(ref(db, `vendors/${user.uid}/${id}`), {
                checkedIn: checkInStatus
            }).then(() => {
                showToast(checkInStatus ? "Check-in realizado!" : "Check-in desmarcado!", "success");
                loadVendors(user.uid);
            }).catch(err => showToast("Erro ao atualizar check-in: " + err.message, "danger"));
        };

        window.removeVendor = (id) => {
            const user = auth.currentUser;
            if (!user) return;
            if (confirm("Tem certeza que deseja remover este vendedor?")) {
                remove(ref(db, `vendors/${user.uid}/${id}`)).then(() => {
                    showToast("Vendedor removido!", "danger");
                    loadVendors(user.uid);
                }).catch(err => showToast("Erro ao remover vendedor: " + err.message, "danger"));
            }
        };

        document.getElementById("resetQueueBtn").onclick = () => {
            const user = auth.currentUser;
            if (!user) return;
            if (confirm("Tem certeza que deseja resetar a fila para o padrÃ£o?")) {
                const vendorsRef = ref(db, `vendors/${user.uid}`);
                allVendors.forEach((vendor, index) => {
                    update(ref(db, `vendors/${user.uid}/${vendor.id}`), {
                        order: index
                    });
                });
                showToast("Fila resetada para o padrÃ£o!", "success");
                loadVendors(user.uid);
            }
        };

        function renderCurrentService() {
            const area = document.getElementById("currentServiceArea");
            const saleForm = document.getElementById("saleForm");
            const vendorSelect = document.getElementById("vendorAssigned");
            if (!currentEmployee) {
                area.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-user"></i></div>
                        <p>Nenhum vendedor em atendimento</p>
                        <button class="btn btn-primary" id="nextBtn" ${currentMode === 'queue' && vendorQueue.length === 0 ? 'disabled' : ''}>
                            Iniciar PrÃ³ximo Atendimento
                        </button>
                    </div>
                `;
                saleForm.style.display = "none";
                vendorSelect.innerHTML = `<option value="">${currentMode === 'queue' ? 'Nenhum vendedor disponÃ­vel' : 'Selecione um vendedor'}</option>`;
                document.getElementById("nextBtn").onclick = nextEmployee;
                return;
            }
            const startTime = currentEmployee.startTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            area.innerHTML = `
                <div class="current-service">
                    <h3>${currentEmployee.name}</h3>
                    <p>${currentEmployee.priority ? 'Prioridade' : 'Vendedor'}</p>
                    <div class="service-time">
                        <span class="icon"><i class="fas fa-clock"></i></span>
                        <span>Iniciado Ã s ${startTime}</span>
                    </div>
                </div>
            `;
            saleForm.style.display = "block";
            vendorSelect.innerHTML = `<option value="${currentEmployee.id}">${currentEmployee.name}</option>`;
        }

        function nextEmployee() {
            if (currentMode !== 'queue') {
                showToast('Use o modo livre para selecionar vendedores diretamente.', 'danger');
                return;
            }
            if (vendorQueue.length === 0) {
                showToast("NÃ£o hÃ¡ mais vendedores na fila de atendimento.", "danger");
                return;
            }
            currentEmployee = { ...vendorQueue[0], startTime: new Date() };
            showToast(`${currentEmployee.name} estÃ¡ agora atendendo.`, "success");
            renderCurrentService();
        }

        document.getElementById("submitSale").onclick = () => {
            const saleResult = document.getElementById("saleResult").value;
            const notSoldReason = document.getElementById("notSoldReason").value.trim();
            const saleDetails = document.getElementById("saleDetails").value.trim();
            const vendorId = document.getElementById("vendorAssigned").value;
            if (!vendorId) {
                showToast("Certifique-se de que hÃ¡ vendedores com check-in na fila.", "danger");
                return;
            }
            const user = auth.currentUser;
            if (user) {
                const salesRef = ref(db, `sales/${user.uid}`);
                const data = {
                    vendorId,
                    vendorName: currentEmployee?.name || "",
                    saleResult,
                    notSoldReason: saleResult === "not_sold" ? notSoldReason : "",
                    saleDetails,
                    timestamp: new Date().toISOString()
                };
                if (editId) {
                    update(ref(db, `sales/${user.uid}/${editId}`), data).then(() => {
                        showToast("Atendimento atualizado!", "success");
                        editId = null;
                        clearForm();
                        updateVendorQueue(user.uid);
                        loadSales(user.uid);
                    });
                } else {
                    push(salesRef, data).then(() => {
                        showToast("Atendimento registrado!", "success");
                        clearForm();
                        updateVendorQueue(user.uid);
                        loadSales(user.uid);
                    });
                }
            }
        };

        function updateVendorQueue(uid) {
            if (currentMode === 'queue' && vendorQueue.length > 0) {
                const vendorsRef = ref(db, `vendors/${uid}`);
                const movedVendor = vendorQueue.shift();
                movedVendor.order = allVendors.length;
                vendorQueue.push(movedVendor);
                vendorQueue.forEach((vendor, index) => {
                    vendor.order = allVendors.findIndex(v => v.id === vendor.id);
                    update(ref(db, `vendors/${user.uid}/${vendor.id}`), {
                        order: vendor.order
                    });
                });
                loadVendors(uid);
            } else {
                loadVendors(uid);
            }
        }

        function loadSales(uid) {
            const salesRef = ref(db, `sales/${uid}`);
            onValue(salesRef, snapshot => {
                const salesList = document.getElementById("salesList");
                salesList.innerHTML = "";
                currentSalesData = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    currentSalesData = Object.entries(data).map(([id, sale]) => ({
                        id,
                        ...sale
                    }));
                    salesList.innerHTML = currentSalesData.map(sale => `
                        <div class="history-item">
                            <div class="employee-info">
                                <h4>${sale.vendorName}</h4>
                                <p>${new Date(sale.timestamp).toLocaleString()}</p>
                                <p>${sale.saleResult === "sold" ? "Venda Realizada" : "NÃ£o Vendido"}</p>
                                ${sale.saleResult === "not_sold" ? `<p>Motivo: ${sale.notSoldReason}</p>` : ""}
                                <p>Detalhes: ${sale.saleDetails || "Nenhum"}</p>
                            </div>
                            <div class="employee-actions">
                                <button class="btn btn-small btn-primary" onclick="editSale('${sale.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-small btn-delete" onclick="deleteSale('${sale.id}')">
                                    <i class="fas fa-trash"></i> Excluir
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    salesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-clipboard-list"></i></div>
                            <p>Nenhum atendimento registrado ainda</p>
                        </div>
                    `;
                }
                updateStats();
            });
        }

        window.editSale = (id) => {
            const user = auth.currentUser;
            if (!user) return;
            const saleRef = ref(db, `sales/${user.uid}/${id}`);
            onValue(saleRef, snapshot => {
                if (snapshot.exists()) {
                    const sale = snapshot.val();
                    document.getElementById("saleResult").value = sale.saleResult;
                    document.getElementById("notSoldReason").value = sale.notSoldReason;
                    document.getElementById("saleDetails").value = sale.saleDetails;
                    document.getElementById("notSoldReasonGroup").style.display = sale.saleResult === "not_sold" ? "block" : "none";
                    editId = id;
                }
            }, { onlyOnce: true });
        };

        window.deleteSale = (id) => {
            const user = auth.currentUser;
            if (!user) return;
            if (confirm("Tem certeza que deseja excluir este atendimento?")) {
                remove(ref(db, `sales/${user.uid}/${id}`)).then(() => {
                    showToast("Atendimento excluÃ­do!", "danger");
                    loadSales(user.uid);
                });
            }
        };

        function clearForm() {
            document.getElementById("saleResult").value = "sold";
            document.getElementById("notSoldReason").value = "";
            document.getElementById("saleDetails").value = "";
            document.getElementById("notSoldReasonGroup").style.display = "none";
        }

        function updateStats() {
            document.getElementById("queueCount").textContent = vendorQueue.length;
            document.getElementById("totalServices").textContent = currentSalesData.length;
            const completedSales = currentSalesData.filter(sale => sale.saleResult === "sold").length;
            document.getElementById("completedSales").textContent = completedSales;
            const successRate = currentSalesData.length > 0 ?
                ((completedSales / currentSalesData.length) * 100).toFixed(1) : "0";
            document.getElementById("successRate").textContent = successRate + "%";
        }

        document.getElementById("exportPdfBtn").onclick = async () => {
            if (currentSalesData.length === 0) {
                showToast("NÃ£o hÃ¡ atendimentos para exportar.", "danger");
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let startY = 20;
            try {
                const imageUrl = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQah2QIOfwC0zx1PXhE11jprq5zvwglscFUFA&s';
                const imageData = await getBase64Image(imageUrl);
                doc.addImage(imageData, 'PNG', 10, 10, 40, 40);
                doc.setFontSize(16);
                doc.text("RelatÃ³rio Lista da Vez", 55, 30);
                startY = 50;
            } catch (e) {
                console.error("Erro ao carregar imagem:", e);
                doc.setFontSize(16);
                doc.text("RelatÃ³rio Lista da Vez", 10, 10);
                startY = 20;
            }
            const tableColumn = ["Vendedor", "Resultado", "Motivo NÃ£o Venda", "Detalhes", "Data"];
            const tableRows = currentSalesData.map(sale => [
                sale.vendorName,
                sale.saleResult === "sold" ? "Venda Realizada" : "NÃ£o Vendido",
                sale.notSoldReason || "-",
                sale.saleDetails || "-",
                new Date(sale.timestamp).toLocaleString()
            ]);
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: startY,
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                headStyles: { fillColor: [34, 139, 34], textColor: [255, 255, 255] },
                alternateRowStyles: { fillColor: [240, 240, 240] }
            });
            doc.save("relatorio_lista_da_vez.pdf");
        };

        document.getElementById("exportExcelBtn").onclick = () => {
            if (currentSalesData.length === 0) {
                showToast("NÃ£o hÃ¡ atendimentos para exportar.", "danger");
                return;
            }
            const worksheet = XLSX.utils.json_to_sheet(currentSalesData.map(sale => ({
                "Vendedor": sale.vendorName,
                "Resultado": sale.saleResult === "sold" ? "Venda Realizada" : "NÃ£o Vendido",
                "Motivo NÃ£o Venda": sale.notSoldReason || "-",
                "Detalhes": sale.saleDetails || "-",
                "Data": new Date(sale.timestamp).toLocaleString()
            })));
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Atendimentos");
            XLSX.writeFile(workbook, "relatorio_lista_da_vez.xlsx");
        };

        document.getElementById("sendReportBtn").onclick = () => {
            const phoneNumber = document.getElementById("phoneNumber").value.trim();
            if (!phoneNumber) {
                showToast("Por favor, insira um nÃºmero de telefone.", "danger");
                return;
            }
            if (currentSalesData.length === 0) {
                showToast("NÃ£o hÃ¡ atendimentos para enviar no relatÃ³rio.", "danger");
                return;
            }
            let reportMessage = "RelatÃ³rio Lista da Vez:\n\n";
            currentSalesData.forEach(sale => {
                reportMessage += `Vendedor: ${sale.vendorName}\n`;
                reportMessage += `Resultado: ${sale.saleResult === "sold" ? "Venda Realizada" : "NÃ£o Vendido"}\n`;
                if (sale.saleResult === "not_sold") {
                    reportMessage += `Motivo: ${sale.notSoldReason}\n`;
                }
                reportMessage += `Detalhes: ${sale.saleDetails || "Nenhum"}\n`;
                reportMessage += `Data: ${new Date(sale.timestamp).toLocaleString()}\n`;
                reportMessage += `--------------------------------------\n`;
            });
            if (confirm("Isso abrirÃ¡ o WhatsApp com a mensagem preenchida. Deseja continuar?")) {
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(reportMessage)}`;
                window.open(whatsappUrl, '_blank');
            }
        };

        document.getElementById("saleResult").addEventListener("change", () => {
            const notSoldReason = document.getElementById("notSoldReasonGroup");
            notSoldReason.style.display = document.getElementById("saleResult").value === "not_sold" ? "block" : "none";
        });

        const themeToggle = document.getElementById("themeToggle");
        themeToggle.addEventListener("click", () => {
            const currentTheme = document.body.getAttribute("data-theme") || "light";
            const newTheme = currentTheme === "light" ? "dark" : "light";
            document.body.setAttribute("data-theme", newTheme);
            themeToggle.innerHTML = newTheme === "light" ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            localStorage.setItem("theme", newTheme);
        });

        const savedTheme = localStorage.getItem("theme") || "light";
        document.body.setAttribute("data-theme", savedTheme);
        themeToggle.innerHTML = savedTheme === "light" ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';

        function getBase64Image(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.src = url;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const dataURL = canvas.toDataURL('image/png');
                    resolve(dataURL);
                };
                img.onerror = (err) => reject(err);
            });
        }
    </script>
</body>
</html>
